{% extends "base-center.html" %}
{% block content_center %}
    <div class="alert alert-success">
        <h4 class="alert-heading">Success!</h4>
        <p>Your files ({{upload_obj.files.values()|join(', ')}}) have been uploaded.</p> 

    </div>

    <div>
        <h4>Live log</h4>
        <div id="log">
            {% for line in logger_msg %}
                <div>{{line}}</div>
            {% endfor %}
        </div>
    </div>
    <div id="done">
    	{% if upload_obj.done %}
        <div class="alert alert-info">
            <span>Data preprocessing completed, please click this link to start analyzing the data: </span>
            <a href="progress/{{upload_obj.dataset_id}}">{{ upload_obj.dataset_id }}</a>
        </div>
    	{% endif %}
        {% if upload_obj.error %}
        <div class="alert alert-danger">
            <span>Data preprocessing failed, please refer to the following error message and double check the format of your data: </span>
            <pre>{{ upload_obj.e }}</pre>
        </div>
        {% endif %}
    </div>

{% endblock %}
{% block scripts %}
    <script type="text/javascript" src="lib/socket.io.min.js"></script>
    <script type="text/javascript">
        
$(document).ready(function(){
	var upload_id = '{{ upload_obj.id }}';
    var enter_point = '/' + window.location.pathname.split('/')[1]
    var namespace = enter_point + '/' + upload_id;
    var url = 'http://' + document.domain + ':' + location.port + namespace
    var socket = io(url, {path: enter_point + '/socket.io'})

    // Event handler for server sent data.
    socket.on('my_response', function(msg) {
    	console.log(msg)
    	if (!msg.done){
    		$('#log').append('<br>'+ $('<div/>').text(msg.data).html());	
    	} else if (msg.done) {
            var divAlert = $('<div>').attr('class', 'alert alert-info')
            divAlert.append($('<span>').text('Data preprocessing completed, please click this link to start analyzing the data: '))
    		var a = $('<a>').text(msg.dataset_id).attr('href', 'progress/' + msg.dataset_id)
            divAlert.append(a)
    		$('#done').append(divAlert)
    	} 
        if (msg.error) {
            var divAlert = $('<div>').attr('class', 'alert alert-danger')
            divAlert.append($('<span>').text('Data preprocessing failed, please refer to the following error message and double check the format of your data: '))
            divAlert.append($('<pre>').text(msg.e))
            $('#done').append(divAlert)
        }
    });

});
    </script>
{% endblock %}
